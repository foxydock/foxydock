map "$ssl_server_name" $preset_ssl_domain_name {
    include snippets/config/by_version/v3/by_context/http/map_sni___preset_ssl_domain.conf;
    "~^\d+\.\d+\.\d+\.\d+$"           "";
    # 匹配顶级域名，保持不变
    "~^[a-zA-Z0-9-]+\.[a-zA-Z]+$"     $ssl_server_name;
    # 匹配根域名，保持不变
    "~^[a-zA-Z]+$"                    $ssl_server_name;
    # 匹配三级及以上域名，提取出主域名 
    "~^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)([a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?)*)$"  $1;
    default                           "";
}

map "$preset_ssl_domain_name" $fdn_ssl_domain_name {
    # 这里需要添加更多的具体映射规则以限制默认行为
    # 建议直接重新写一个 map
    # 若不采取行动，可能会导致安全事故
    # 需要额外自定义 "" 的映射规则
    default    $preset_ssl_domain_name;
}

map "$fdn_ssl_domain_name" $cert_dir_name {
    # 这里需要添加更多的具体映射规则以限制默认行为
    # 建议直接重新写一个 map
    # 若不采取行动，可能会导致安全事故
    default     $fdn_ssl_domain_name;
}

map "$cert_dir_name" $path_to_cert_file {
    default     /etc/nginx/ssl/${cert_dir_name}/fullchain.pem;
}

map "$cert_dir_name" $path_to_cert_key_file {
    default     /etc/nginx/ssl/${cert_dir_name}/key.pem;
}

map "$http_upgrade" $fdn_connection_upgrade {
    ""              close;
    # keep-alive    keep-alive;
    default         upgrade;
}

# Generated by AI TongYi And ChatGPT
# 定义一个 map，将 $host 转换为 $clean_host
map "$host" $clean_host {
    "~*^\[([0-9a-f:]+)\](?::(\d+))?$" "[$1]";  # 匹配 IPv6 地址，可能带端口号
    "~^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?::(\d+))?$" $host;  # 匹配 IPv4 地址，可能带端口号
    "~*^([a-z0-9](-[a-z0-9]*)?(\.[a-z0-9](-[a-z0-9]*)?)+)(?::(\d+))?$" $1;  # 匹配主机名，可能带端口号  # 匹配主机名，可能带端口号
    default $host;  # 默认情况下，$clean_host 等于 $host
}

map "${clean_host}_${fdn_ssl_domain_name}_${fdn_app_name}" $access_log_file_name {
    # 能提取出 fdn_app_name 时已经符合合法域名的要求
    "~*^.+_.+_[a-z0-9-]+$"                                           access_app_${fdn_app_name}.log;
    # 能匹配上 SSL 证书的有效域名
    "~*^(?:[a-z0-9-]+\.)*([a-z]{2,})_(?:[a-z0-9-]+\.)*([a-z]{2,})_$" access_tls_${fdn_ssl_domain_name}.log;
    # 纯 HTTP 请求但是 Host 有合法域名的
    "~*^(?:[a-z0-9-]+\.)*([a-z]{2,})__$"                             access_plain_http.log;
    # 未知的请求 例如纯 IP 地址访问
    default                                                          access.log;
}

map "$clean_host" $loggable {
    default       1;
}

map "$ssl_server_name" $fdn_ingress_scheme {
    ""          http;
    default     https;
}

# Proxy Protocol 优先
map "${proxy_protocol_server_port}_${server_port}" $fdn_ingress_server_port {
    "~*^.+_.*"    $proxy_protocol_server_port;
    default       $server_port;
}

map "${proxy_protocol_addr}_${remote_addr}" $fdn_ingress_remote_addr {
    "~*^.+_.*"    $proxy_protocol_addr;
    default       $remote_addr;
}

# 处理内部转发逐步丢失服务器端口导致的 QUIC 升级失败
# 优先级：
# 1. http_x_fdn_ingress_server_port
# 2. proxy_protocol_server_port
# 3. http_x_forwarded_port
# 4. server_port
map "${http_x_fdn_ingress_server_port}_${proxy_protocol_server_port}_${http_x_forwarded_port}_${server_port}" $fdn_server_port {
    "~*^.+_.*_.*_.*"    $http_x_fdn_ingress_server_port;
    "~*^_.+_.*_.*"      $proxy_protocol_server_port;
    "~*^__.+_.*"        $http_x_forwarded_port;
    default             $server_port;
}

map "${http_x_fdn_ingress_remote_addr}_${proxy_protocol_addr}_${http_x_real_ip}_${remote_addr}" $fdn_remote_addr {
    "~*^.+_.*_.*_.*"    $http_x_fdn_ingress_remote_addr;
    "~*^_.+_.*_.*"      $proxy_protocol_addr;
    "~*^__.+_.*"        $http_x_real_ip;
    default             $remote_addr;
}

map "${http_x_fdn_ingress_scheme}_${http_x_forwarded_proto}_${scheme}" $fdn_scheme {
    "~*^.+_.*_.*"     $http_x_fdn_ingress_scheme;
    "~*^_.+_.*"       $http_x_forwarded_proto;
    default           $scheme;
}

map "${proxy_add_x_forwarded_for}" $fdn_proxy_x_forwarded_for {
    "unix:"                $fdn_remote_addr;
    default                $proxy_add_x_forwarded_for;
}


map "$http3" $fdn_http3_compatible_host_for_proxy {
    h3          ${clean_host}:${fdn_server_port};
    hq          ${clean_host}:${fdn_server_port};
    default     $http_host;
}

map "${scheme}${fdn_server_port}" $fdn_root_request_url {
    https443    ${scheme}://${clean_host};
    http80      ${scheme}://${clean_host};
    default     ${scheme}://${fdn_http3_compatible_host_for_proxy};
}

map "${fdn_root_request_url}" $fdn_full_request_url {
    default     ${fdn_root_request_url}${request_uri};
}

include snippets/config/by_version/v3/by_context/http/inject_leaf_map.conf;
